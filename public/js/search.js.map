{"version":3,"sources":["search.coffee"],"names":[],"mappings":"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","file":"search.js","sourcesContent":["# Globals\n# ----------------------------\n\n$results = []\n$vinylData = {}\n$search = null\n\n# Submit Search\n# ----------------------------\n\n$('#submit-search').click (e) ->\n    console.log 'Hello from search.'\n\n    # show loading icon, hide and clear result table\n    e.preventDefault()\n    $('.loading').fadeIn()\n    $('.search-help').hide()\n    $('.search-results-table').hide()\n    $('.no-results').hide()\n    $('.search-results-table').find('tbody').html('')\n\n    # request data from discogs.com\n    $search = $.ajax\n        url: '/search'\n        type: 'POST'\n        data:\n            _token: $(\"#search-vinyl-form input[name='_token']\").val()\n            artist: $(\"#search-vinyl-form input[name='artist']\").val()\n            title: $(\"#search-vinyl-form input[name='title']\").val()\n            catno: $(\"#search-vinyl-form input[name='catno']\").val()\n        dataType: 'JSON'\n        error: (x,status,error) ->\n            console.log status\n            console.log error\n            if error == 'abort'\n                $('.loading').fadeOut()\n            else\n                $('.loading').html('<p class=\"placeholder\">Oops! <br> Try refreshing your Discogs Connection</p><a href=\"/oauth/discogs\" class=\"btn btn-lg btn-primary\"><i class=\"fa fa-fw fa-exchange\"></i> Refresh Discogs Token</a>')\n\n        success: (results) -> # search results received\n            console.log results\n            $results = results\n            $index = 0\n            $('.loading').fadeOut ->\n                if results.length\n                    $('.search-results-table').fadeIn()\n                    _.each results, (result) ->\n                        #console.log result\n\n                        # artist\n                        if result.artists\n                            $artist = result.artists[0].name\n                        else\n                            $artist = '<em>unknown artist</em>'\n\n                        # cover\n                        if result.images\n                            $cover = result.images[0].uri150\n                        else\n                            $cover = '/images/PH_vinyl.svg'\n\n                        # title\n                        if result.title\n                            $title = result.title\n                        else\n                            $title = '<em>unknown title</em>'\n\n                        # catno\n                        if result.type == 'release'\n                            $catno = result.labels[0].catno\n                        else\n                            $catno = '<em>no catalog number</em>'\n\n                        # link\n                        $link = '/vinyl/add?id='+result.id+'?type='+result.type\n\n                        $vinyl = '<tr><td class=\"cover\"><img src=\"'+$cover+'\" alt=\"cover\"></td><td>'+$artist+'</td><td>'+$title+'</td><td>'+$catno+'</td><td><!--<a href=\"'+$link+'\" class=\"btn btn-sm btn-info\"><i class=\"fa fa-fw fa-edit\"></i> Edit</a>--><button class=\"btn btn-sm btn-success quick-add\" data-toggle=\"modal\" data-target=\"#quickAddVinyl\" data-result=\"'+$index+'\"><i class=\"fa fa-fw fa-plus\"></i> Add</button></td></tr>'\n                        $('.search-results-table').find('tbody').append($vinyl)\n\n                        # increase index\n                        $index++\n                else\n                    $('.no-results').fadeIn()\n\n# Cancel search\n# ----------------------------\n\n$('#cancel-search').click ->\n    $('.search-help').fadeIn()\n    $('.loading').fadeOut()\n    $search.abort()\n\n# Close Modal\n# ----------------------------\n\n$('#quickAddVinyl').on 'hidden.bs.modal', (e) ->\n    modal = $(this)\n    $('#searchModalSubmit').disabled = true # disable submit\n    $('#addVinylForm .trackInfo').remove() # remove track infos\n    $('#currencyLabel').hide() # remove price\n    modal.find('input[name=\"price\"]').before('<input type=\"hidden\" name=\"price\"/>').remove()\n    unless($('#price').length) # as long as not already present\n        modal.find('input[name=\"price\"]').before('<p class=\"h1\" id=\"price\">Fetching...</p>') # show price text\n    else\n        $('#price').text('Fetching...')\n    $('#priceLabelText').text('Discogs median price:')\n\n# Quick add\n# ----------------------------\n\n$('#quickAddVinyl').on 'show.bs.modal', (e) ->\n    button = $(e.relatedTarget)\n    vinyl_index = button.data 'result'\n    vinyl = $results[vinyl_index]\n    modal = $(this)\n    console.log vinyl\n\n    # fetch Spotify tracklist\n    $spotify = $.ajax\n        url: 'https://api.spotify.com/v1/search?q=album%3A'+vinyl.title+'+artist%3A'+vinyl.artists[0].name+'&type=album'\n        type: 'GET'\n        dataType: 'JSON'\n        error: (x,status,error) ->\n            console.log status\n            console.log error\n        success: (results) -> # search results received\n            # console.log results\n            if(results.albums.items.length)\n                $('#spotify').html('<iframe src=\"https://embed.spotify.com/?uri=spotify%3Aalbum%3A'+results.albums.items[0].id+'\" width=\"100%\" height=\"380\" frameborder=\"0\" allowtransparency=\"true\"></iframe>')\n                $vinylData.spotify_id = results.albums.items[0].id\n\n    # fetch price\n    userCurrency = $('#userCurrency').val()\n    ### Disabled until Discogs allows to fetch a price again\n    $.fetchPrice vinyl.id, userCurrency, (price) ->\n        # show the price & add to form\n        if(isNaN(price))\n            # no prices on Discogs -> show text input for price\n            modal.find('input[name=\"price\"]').before('<input type=\"text\" name=\"price\" class=\"form-control\" placeholder=\"required\" required aria-describedby=\"currencyLabel\"/>').remove()\n            $('#currencyLabel').text(userCurrency).show()\n            $('#price').remove()\n            $('#priceLabelText').text('What did you pay?')\n        else\n            $('#price').html(price+' '+userCurrency)\n            modal.find('input[name=\"price\"]').val(price)\n    ###\n\n    # no prices on Discogs -> show text input for price\n    modal.find('input[name=\"price\"]').before('<input type=\"text\" name=\"price\" class=\"form-control\" placeholder=\"required\" required aria-describedby=\"currencyLabel\"/>').remove()\n    $('#currencyLabel').text(userCurrency).show()\n    $('#price').remove()\n    $('#priceLabelText').text('What did you pay?')\n\n    # enable submit button\n    $('#searchModalSubmit').disabled = false\n\n    # map fetched vinyl data to object required to create vinyl\n    $vinylData = $.mapVinylData vinyl\n\n    # visible form data\n    modal.find('.modal-title').text('Add \"' + vinyl.artists[0].name + ' - '+ vinyl.title + '\" to collection')\n    modal.find('.modal-body .cover').html('<img src=\"'+$vinylData.cover+'\" class=\"thumbnail\" width=\"100%\">')\n\n# Submit Add Modal\n# ----------------------------\n\n$('#searchModalSubmit').on 'click', (e) ->\n    e.preventDefault()\n    e.stopPropagation()\n\n    button = e.target\n    $vinylData._token = $(button).data 'token' # attach CSRF token\n    $vinylData.price = $('#quickAddVinyl').find('input[name=price]').val()\n    console.log $vinylData\n    # fetch Spotify tracklist\n    $createVinyl = $.ajax\n        url: '/vinyl/create'\n        type: 'POST'\n        data: $vinylData\n        success: (response) ->\n            console.log 'vinyl added!'\n            $('#quickAddVinyl').modal('hide')\n            $('body').append('<div class=\"flash-message\"><div class=\"alert alert-success fade in\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-hidden=\"true\">×</button><a href=\"/vinyl/'+response.id+'\"><b>'+ $vinylData.artist + ' - ' + $vinylData.title + '</b></a> is now in your collection.</div></div>')\n        error: (error) ->\n            console.warn error\n            $('body').append '<div class=\"flash-message\"><div class=\"alert alert-danger fade in\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-hidden=\"true\">×</button>Oops! Something went wrong, please try again.</div></div>'\n"],"sourceRoot":"/source/"}